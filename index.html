<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Speed Up Your Tests with setUpTestData</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/django.css" id="theme">

    <!-- <link rel="stylesheet" href="css/theme/django.css"> -->

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">

<section>
  <h1>Speed Up Your Tests with setUpTestData</h1>
  <h2>Adam Johnson</h2>
</section>

<section>
  <h2>Five part talk</h2>
  <ol>
    <li>unittest’s <code>setUp*</code> &amp; <code>tearDown*</code> methods</li>
    <li>Django’s unittest extensions</li>
    <li><code>setUpTestData()</code></li>
    <li>Django 3.2’s <code>setUpTestData()</code> isolation</li>
    <li>How to convert a <code>TestCase</code> to use <code>setUpTestData()</code></li>
  </ol>
</section>

<section>
  <h2>1. unittest’s <code>setUp*</code> &amp; <code>tearDown*</code> methods</h2>
</section>

<section>
  <ul>
    <li>Per-test: <code>setUp()</code>, <code>tearDown()</code></li>
    <li>Per-<code>TestCase</code>: <code>setUpClass()</code>, <code>tearDownClass()</code></li>
  </ul>
</section>

<section>
  <pre><code class="language-python">class MyTests(TestCase):
    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        cls.conn = acme.connect()

    @classmethod
    def tearDownClass(cls):
        super().tearDownClass()
        cls.conn.close()

    def setUp(self):
        super().setUp()
        self.user = make_user(self.conn)

    def tearDown(self):
        self.user.delete()
        super().tearDown()
</code></pre>
</section>

<section>
  <p><em>Robust use:</em></p>
  <pre><code class="language-python">class MyTests(TestCase):
  def setUp(self):
      super().setUp()
      self.user = make_user(self.conn)

  def tearDown(self):
      if hasattr(self, "user"):
          self.user.delete()
      super().tearDown()
</code></pre>
</section>

<section>
  <p><em>...or:</em></p>
  <ul>
    <li><code>self.addCleanup(func)</code></li>
    <li>Python 3.8+: <code>cls.addClassCleanup(func)</code></li>
  </ul>
</section>

<section>
  <pre><code class="language-python">class MyTests(TestCase):
    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        cls.conn = acme.connect()
        self.addClassCleanup(cls.conn.close)

    def setUp(self):
        super().setUp()
        self.user = make_user(self.conn)
        self.addCleanup(self.user.delete)
</code></pre>
</section>

<section>
  <h3><code>TestCase</code> lifecycle</h3>
  <ol>
    <li><code>setUpClass()</code></li>
    <li>
      <em>Per test:</em>
      <ol>
        <li><code>setUp()</code></li>
        <li><em>run test</em></li>
        <li><code>tearDown()</code></li>
        <li><code>addCleanup()</code> functions</li>
      </ol>
    </li>
    <li><code>tearDownClass()</code></li>
    <li><code>addClassCleanup()</code> functions</li>
  </ol>
</section>

<section>
  <h2>2. Django’s unittest extensions</h2>
</section>

<section>
  <p>
    <code>unittest.TestCase</code><br>
    ⬇️<br>
    <code>SimpleTestCase</code><br>
    ⬇️<br>
    <code>TransactionTestCase</code><br>
    ⬇️<br>
    <code>TestCase</code><br>
    (⬇️)<br>
    (<code>LiveServerTestCase</code>)
  </p>
  </ul>
</section>

<section>
  <h3><code>SimpleTestCase</code></h3>
  <ul>
    <li>Blocks DB access</li>
    <li>Adds some assertion methods</li>
    <li>Does Django’s own per-test setup <em>outside of</em> <code>setUp()</code></li>
  </ul>
</section>

<section>
  <h3><code>TransactionTestCase</code></h3>
  <ul>
    <li>Allows DB access</li>
    <li>Rolls back DB’s by wiping and re-adding fixture data (slow)</li>
    <li>Allows testing code using transactions</li>
  </ul>
</section>

<section>
  <h3><code>TestCase</code></h3>
  <ul>
    <li>Rolls back DB’s with <strong>per-class</strong> and <strong>per-test</strong> transactions</li>
    <li><code>setUpClass()</code> calls <code>setUpTestData()</code></li>
  </ul>
</section>

<section>
  <h3><code>TestCase</code></h3>
  <ol>
    <li><code>setUpClass()</code>: tx begin</li>
    <li><code>setUpClass()</code>: <code>setUpTestData()</code></li>
    <li>
      <em>Per test:</em>
      <ol>
        <li><code>_pre_setup()</code>: tx begin</li>
        <li><em>run test</em></li>
        <li><code>_post_teardown()</code>: tx rollback</li>
      </ol>
    </li>
    <li><code>tearDownClass()</code>: tx rollback</li>
  </ol>
</section>

<section>
  <h2>3. <code>setUpTestData()</code></h2>
</section>

<section>
  <ul>
    <li><code>@classmethod</code></li>
    <li>Called under <code>setUpClass()</code></li>
    <li>Default empty so no need to call <code>super()</code></li>
  </ul>
</section>

<section>
  <pre><code class="language-python">class MyTests(TestCase):
    @classmethod
    def setUpTestData(cls):
      cls.book = Book.objects.create(title="1984")

    ...
</code></pre>
</section>

<section>
  <ul>
    <li>Data creation in <code>setUp()</code>: N times</li>
    <li>Data creation in <code>setUpTestData()</code>: once</li>
    <li>Easiest way to speed up tests</li>
  </ul>
</section>

<section>
  <h2>4. Django 3.2’s <code>setUpTestData()</code> isolation</h2>
</section>

<section>
  <pre><code class="language-python">class MyTests(TestCase):
    @classmethod
    def setUpTestData(cls):
        cls.book = Book.objects.create(title="Meditations")

    def test_that_changes_title(self):
        self.book.title = "Antifragile"

    def test_that_reads_title_from_db(self):
        db_title = Book.objects.get().title
        assert db_title == "Meditations"

    def test_that_reads_in_memory_title(self):
        assert self.book.title == "Meditations"
</code></pre>
</section>

<section>
  <p><em>Django &lt; 3.2</em></p>
  <pre><code class="language-console">$ ./manage.py test example.core.tests
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
.F.
======================================================================
FAIL: test_that_reads_in_memory_title (example.core.tests.MyTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/.../example/core/tests.py", line 19, in test_that_reads_in_memory_title
    assert self.book.title == "Meditations"
AssertionError

----------------------------------------------------------------------
Ran 3 tests in 0.002s

FAILED (failures=1)
Destroying test database for alias 'default'...
</code></pre>
</section>

<section>
  <ul>
    <li>Database changes rolled back by transaction</li>
    <li>In-memory changes weren’t automatically rolled back</li>
    <li>Docs told you to re-query for models in each test - slow and verbose</li>
  </ul>
</section>

<section>
  <p>django-testdata: automatic copying of <code>setUpTestData()</code> data</p>
  <pre><code class="language-python">from testdata import wrap_testdata

class MyTests(TestCase):
    @classmethod
    @wrap_testdata
    def setUpTestData(cls):
        cls.book = Book.objects.create(title="Meditations")

    ...
</code></pre>
</section>

<section>
  <p>django-testdata merged in Django 3.2</p>
    <pre><code class="language-python">class MyTests(TestCase):
    @classmethod
    def setUpTestData(cls):
        cls.book = Book.objects.create(title="Meditations")

    ...
  </code></pre>
</section>

<section>
  <h2>5. How to convert a <code>TestCase</code> to use <code>setUpTestData()</code></h2>
</section>

<section>
  <ul>
    <li>Four steps</li>
    <li>See blog post: <strong>How to convert a TestCase from setUp() to setUpTestData()</strong></li>
  </ul>
</section>

<section>
  <pre><code class="language-python">class IndexTests(TestCase):
    def setUp(self):
        self.book = Book.objects.create(title="1984")
        self.user = User.objects.create_user(
            username="tester",
            email="test@example.com",
        )
        self.client.force_login(self.user)

    def test_one(self):
        ...

    def test_two(self):
        ...
</code></pre>
</section>

<section>
  <h2>Step 0. Install django-testdata on Django &lt; 3.2</h2>
</section>

<section>
  <h2>Step 1. Run the target test case</h2>
  <pre><code class="language-console">$ ./manage.py test --keepdb example.core.tests.IndexTests
Using existing test database for alias 'default'...
System check identified no issues (0 silenced).
..
-------------------------------------------------------------
Ran 2 tests in 0.015s

OK
Preserving test database for alias 'default'...
</code></pre>
</section>

<section>
  <h2>Step 2. Add a stub <code>setUpTestData()</code></h2>
  <pre><code class="language-diff"> class IndexTests(TestCase):
+    @classmethod
+    def setUpTestData(cls):
+
     def setUp(self):
         self.book = Book.objects.create(title="1984")
         self.user = User.objects.create_user(
</code></pre>
</section>

<section>
  <p>On Django &lt; 3.2:</p>
  <pre><code class="language-diff">+from testdata import wrap_testdata

 from example.core.models import Book


 class IndexTests(TestCase):
+    @classmethod
+    @wrap_testdata
+    def setUpTestData(cls):
+
     def setUp(self):
         self.book = Book.objects.create(title="1984")
         self.user = User.objects.create_user(
</code></pre>
</section>

<section>
  <h2>Step 3. Move data creation from <code>setUp()</code> to <code>setUpTestData()</code></h2>
</section>

<section>
  <pre><code class="language-diff">class IndexTests(TestCase):
     @classmethod
     def setUpTestData(cls):
+        cls.book = Book.objects.create(title="1984")
+        cls.user = User.objects.create_user(
+            username="tester",
+            email="test@example.com",
+        )

     def setUp(self):
-        self.book = Book.objects.create(title="1984")
-        self.user = User.objects.create_user(
-            username="tester", email="test@example.com"
-        )
         self.client.force_login(self.user)

     def test_one(self):
</code></pre>
</section>

<section>
  <pre><code class="language-python">class IndexTests(TestCase):
    @classmethod
    def setUpTestData(cls):
        cls.book = Book.objects.create(title="1984")
        cls.user = User.objects.create_user(
            username="tester",
            email="test@example.com",
        )

    def setUp(self):
        self.client.force_login(self.user)

    def test_one(self):
        ...

    def test_two(self):
        ...
</code></pre>
</section>

<section>
  <h2>Step 4. Re-run tests</h2>
  <pre><code class="language-console">$ ./manage.py test --keepdb example.core.tests.IndexTests
Using existing test database for alias 'default'...
System check identified no issues (0 silenced).
..
-------------------------------------------------------------
Ran 2 tests in 0.012s

OK
Preserving test database for alias 'default'...
</code></pre>
    <p>Enjoy N ➡️ 1 performance gain</p>
</section>

<section>
  <h1>Thank you! 🤗</h1>
  <ul>
    <li>Adam Johnson</li>
    <li>@adamchainz on GitHub &amp; Twitter</li>
    <li>me@adamj.eu</li>
    <li><a href="https://github.com/adamchainz/talk-speed-up-your-tests-with-setuptestdata">github.com/adamchainz/talk-speed-up-your-tests-with-setuptestdata</a></li>
  </ul>
</section>

      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
          hash: true,

          controls: false,
          center: false,
          progress: false,

          // Learn about plugins: https://revealjs.com/plugins/
          plugins: [ RevealHighlight ]
      });
    </script>
  </body>
</html>
